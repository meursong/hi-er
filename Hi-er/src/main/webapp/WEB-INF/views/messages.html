<!DOCTYPE html>
<html
        lang="en"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{common/layout}"
>
<head>
    <style>
        .list:hover {
            cursor: Pointer;
            opacity: 60%;

        }

        .msl {
            margin: 3px 0;
        }
    </style>
    =
</head>
<section layout:fragment="contents">
    <div class="py-5">
        <div class="container">
            <div class="row">
                <!-- Main Content -->
                <main class="col col-xl-9 order-xl-2 col-lg-12 order-lg-1 col-md-12 col-sm-12 col-12">
                    <div class="box shadow-sm rounded bg-white mb-3 osahan-chat">
                        <h5 class="pl-3 pt-3 pr-3 border-bottom mb-0 pb-3">Messaging</h5>
                        <div class="row m-0">
                            <div class="border-right col-lg-5 col-xl-4 px-0">
                                <div class="osahan-chat-left">
                                    <div class="position-relative icon-form-control p-3 border-bottom">
                                        <i class="fa fa-search position-absolute"></i>
                                        <input id="searchMsg" placeholder="Search messages" type="text" class="form-control">
                                    </div>
                                    <div id="ms" class="osahan-chat-list">

                                        <div  style="width: 100%" th:each="msgList : ${msgList}" onclick="view(this)"
                                             th:name="${msgList.msg_id}"
                                             class="p-3 d-flex align-items-center osahan-post-header overflow-hidden list">
                                            <div class="dropdown-list-image mr-3">
                                                <div class="dropdown-list-image mr-3 d-flex align-items-center bg-success justify-content-center rounded-circle text-white">

                                                </div>
                                            </div>
                                            <div class="font-weight-bold mr-1 overflow-hidden">
                                                <div th:text="${msgList.send_nickname}" class="text-truncate">Stacie
                                                    Hall
                                                </div>
                                                <div th:text="${msgList.title}"
                                                     class="small text-truncate overflow-hidden text-black-50">
                                                </div>
                                            </div>
                                            <span class="ml-auto mb-auto">
                                       <div class="text-right text-muted pt-1 small msl" th:text="${msgList.send_time}">00:21PM</div>
                                                 <div class="text-right text-muted pt-1 small msl"
                                                      th:text="${msgList.read_chk}==0?'읽음'">00:21PM</div>
                                    </span>
                                        </div>
                                        <div class="footer-pagination text-center">
                                            <nav th:replace="fragments/pagination :: pagination"></nav>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="msg_list" class="col-lg-7 col-xl-8 px-0">
                                <div class="p-3 d-flex align-items-center  border-bottom osahan-post-header">
                                    <div class="font-weight-bold mr-1 overflow-hidden">
                                        <div class="text-truncate">Carl Jenkins
                                        </div>
                                        <div class="small text-truncate overflow-hidden text-black-50">Askbootstap.com -
                                            Become a Product Manager with super power
                                        </div>
                                    </div>
                                    <span class="ml-auto">
                                 <div class="btn-group">
                                    <button type="button" class="btn btn-light btn-sm rounded" data-toggle="dropdown"
                                            aria-haspopup="true" aria-expanded="false">
                                    <i class="mdi mdi-dots-vertical"></i>
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-right">
                                       <button class="dropdown-item" type="button"><i class="mdi mdi-trash"></i> Delete</button>
                                       <button class="dropdown-item" type="button"><i class="mdi mdi-x-circle"></i> Turn Off</button>
                                    </div>
                                 </div>
                              </span>
                                </div>
                                <div th:each="message_view : ${message_view}" style="margin: 0 auto"
                                     class="osahan-chat-box p-3 border-top border-bottom bg-light">
                                    <h3 th:text="${message_view.title}" name="title" style="text-align: center; border-bottom: #d4f8f2 solid">msg_list</h3>
                                    <h5 th:text="${message_view.content}" style="text-align: center; margin-top: 20px">msg_list</h5>
                                </div>
                                <div class="w-100 border-top border-bottom">

                                </div>
                                <div class="p-3 d-flex align-items-center">
                                    <span class="ml-auto">
                              <button style="margin: 38px 207px" th:onclick="check()" type="button" class="btn btn-success btn-sm rounded" data-toggle="modal" data-target="#exampleModal">
                              <i class="mdi mdi-send"></i> 답장 보내기
                              </button>
                              </span>
                                    <div th:replace="fragments/message :: message_modal"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
                <aside class="col col-xl-3 order-xl-2 col-lg-12 order-lg-2 col-12">
                    <div class="box mb-3 shadow-sm rounded bg-white list-sidebar">
                        <div class="box-title p-3">
                            <h6 class="m-0">Manage my network</h6>
                        </div>
                        <ul class="list-group list-group-flush">
                            <a href="#">
                                <li class="list-group-item pl-3 pr-3 d-flex align-items-center text-dark"><i
                                        class="mdi mdi-account mr-2 text-dark"></i> Connections <span
                                        class="ml-auto font-weight-bold">68</span></li>
                            </a>
                            <a href="#">
                                <li class="list-group-item pl-3 pr-3 d-flex align-items-center text-dark"><i
                                        class="mdi mdi-book mr-2 text-dark"></i> Contacts <span
                                        class="ml-auto font-weight-bold">869</span></li>
                            </a>
                            <a href="#">
                                <li class="list-group-item pl-3 pr-3 d-flex align-items-center text-dark"><i
                                        class="mdi mdi-account-multiple-plus mr-2 text-dark"></i> People I Follow <span
                                        class="ml-auto font-weight-bold">156</span></li>
                            </a>
                            <a href="#">
                                <li class="list-group-item pl-3 pr-3 d-flex align-items-center text-dark"><i
                                        class="mdi mdi-account-convert mr-2 text-dark"></i> Groups <span
                                        class="ml-auto font-weight-bold">15</span></li>
                            </a>
                            <a href="#">
                                <li class="list-group-item pl-3 pr-3 d-flex align-items-center text-dark"><i
                                        class="mdi mdi-clipboard mr-2 text-dark"></i> Page <span
                                        class="ml-auto font-weight-bold">3</span></li>
                            </a>
                            <a href="#">
                                <li class="list-group-item pl-3 pr-3 d-flex align-items-center text-dark"><i
                                        class="mdi mdi-tag mr-2 text-dark"></i> Hashtag <span
                                        class="ml-auto font-weight-bold">8</span></li>
                            </a>
                        </ul>
                    </div>
                    <div class="box shadow-sm mb-3 rounded bg-white ads-box text-center">
                        <div class="image-overlap-2 pt-4">
                            <img src="images/l3.png" class="img-fluid rounded-circle shadow-sm" alt="Responsive image">
                            <img src="images/user/s8.png" class="img-fluid rounded-circle shadow-sm"
                                 alt="Responsive image">
                        </div>
                        <div class="p-3 border-bottom">
                            <h6 class="text-dark">Gurdeep, grow your career by following <span class="font-weight-bold"> Askbootsrap</span>
                            </h6>
                            <p class="mb-0 text-muted">Stay up-to industry trends!</p>
                        </div>
                        <div class="p-3">
                            <button type="button" class="btn btn-outline-success btn-sm pl-4 pr-4"> FOLLOW</button>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>
</section>
</html>

<script>
    function view(e) {
        const msg_id = $(e).attr('name');
        console.log(msg_id);
        console.log("/" + msg_id);

        $.ajax({
            type: "POST",
            url: "/message/" + msg_id,
            success: function (data) {
                console.log("성공");
                $("#ms").load(location.href + " #ms");

            }
        }).done(function (fragment) {
            $("#msg_list").replaceWith(fragment);
        });
    }

    function send() {
        const title = $('#title').val();
        const content = $('#content').val();

        if(title=="") {
            swal("제목을 입력해주세요.");
            return;
        }
        if(content=="") {
            swal("메세지를 입력해주세요.");
            return;
        }

        const messageForm = {
            recv_user_id: '',
            title: $("#title").val(),
            content: $("#content").val(),
        }

        $.ajax({
            type: "POST",
            url: "/send",
            cache: false,
            data: messageForm,
            success: function(data) {
                swal(data)
                if(data=="메세지 전송 성공!!") {
                    $('#exampleModal').modal('hide');
                }
            },
            error: function (request, status, error) {
                console.log(err);
            }
        })

    }
    $('.modal').on('hidden.bs.modal', function (e) {
        console.log('modal close');
        $(this).find('form')[0].reset()
    });

    function check() {

        if($("h3[name=title]").val()==null) {
            swal("알림", "답변할 메세지를 선택해 주세요.");
            $('#exampleModal').modal('hide');

        }
        // swal($("h3[name=title]").val());
    }

    $("#searchMsg").on("keyup",function(key){
        const keyword = $("input[id='searchMsg']").val();
        if(key.keyCode==13) {
            if(keyword=="") {
                swal("알림","검색어를 입력해주세요.");
            }
            else {
                // location.href =
            }

        }
    });



</script>
